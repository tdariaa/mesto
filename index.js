(()=>{"use strict";const t={formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__button",inactiveButtonClass:"popup__button_inactive",inputErrorClass:"popup__input_type_error",errorClass:"popup__error_visible"},e=document.querySelector(".profile__edit-button"),n=document.querySelector(".popup__form_profile"),s=document.querySelector(".profile__add-button"),i=document.querySelector(".popup__form_card"),o=document.querySelector(".profile__avatar"),r=(i.querySelector(".popup__input_type_name-card"),i.querySelector(".popup__input_type_link"),"#elements"),a=(document.querySelector(".popup_warning"),document.querySelector(".popup__form_avatar"));class l{constructor(t,e,n,s,i,o){this._data=t,this._name=t.name,this._link=t.link,this._likes=t.likes,this._cardID=t._id,this._profileInfo=i,this._cardOwnerID=t.owner._id,this._templateSelector=e,this._openPopup=n,this._openPopupWarning=s,this._likesLength=t.likes.length,this._handleLike=o}_getTemplate(){return document.querySelector(this._templateSelector).content.querySelector(".elements__card").cloneNode(!0)}generateCard(){return this._element=this._getTemplate(),this._cardImage=this._element.querySelector(".elements__photo"),this._likeButton=this._element.querySelector(".elements__like_button"),this._likeCounter=this._element.querySelector(".elenents__like_counter"),this._deleteButton=this._element.querySelector(".elements__trash"),this._setEventListeners(),this._removeTrashButton(),this._cardImage.src=this._link,this._element.querySelector(".elements__name").textContent=this._name,this._cardImage.alt=this._name,this._isCardLiked(),this._likeCounter.textContent=this._likes.length,this._element}_removeTrashButton(){this._cardOwnerID!==this._profileInfo._id&&this._deleteButton.remove()}_isCardLiked(){this._likeChecker()?this._likeButton.classList.remove("elements__like_button_active"):this._likeButton.classList.add("elements__like_button_active")}_likeChecker(){return(t=>this._likes.every((t=>t._id!==this._profileInfo._id)))()}dislikeCard(t){this._likeButton.classList.remove("elements__like_button_active"),this._likeCounter.textContent=t.likes.length}likeCard(t){this._likeButton.classList.add("elements__like_button_active"),this._likeCounter.textContent=t.likes.length}_warningPopup(){this._openPopupWarning(this)}removeCard(){this._element.remove()}_openCard(){const t={name:this._name,link:this._link};this._openPopup(t)}_setEventListeners(){this._cardImage.addEventListener("click",(()=>{this._openCard()})),this._likeButton.addEventListener("click",(t=>{this._handleLike(this._cardID,t)})),this._deleteButton.addEventListener("click",(()=>{this._warningPopup()}))}}class h{constructor(t,e){this._validationConfig=t,this._validationFormElement=e}enableValidation(){this._inputList=Array.from(this._validationFormElement.querySelectorAll(this._validationConfig.inputSelector)),this._setEventListeners()}_setEventListeners(){this._buttonElement=this._validationFormElement.querySelector(this._validationConfig.submitButtonSelector),this._inputList.forEach((t=>{t.addEventListener("input",(()=>{this._checkInputValidity(t),this._toggleButtonState()}))}))}_checkInputValidity(t){t.checkValidity()?this._hideError(t):this._showError(t)}_showError(t){this._validationFormElement.querySelector(`.${t.id}-error`).textContent=t.validationMessage,t.classList.add(this._validationConfig.inputErrorClass)}_hideError(t){this._validationFormElement.querySelector(`.${t.id}-error`).textContent="",t.classList.remove(this._validationConfig.inputErrorClass)}_toggleButtonState(){this._hasInvalidInput()?this._disableButton():this._enableButton()}_hasInvalidInput(){return this._inputList.some((t=>!t.validity.valid))}_enableButton(){this._buttonElement.classList.remove(this._validationConfig.inactiveButtonClass),this._buttonElement.removeAttribute("disabled",!0)}_disableButton(){this._buttonElement.classList.add(this._validationConfig.inactiveButtonClass),this._buttonElement.setAttribute("disabled",!0)}resetInput(){this._inputList.forEach((t=>{this._hideError(t),this._toggleButtonState()}))}}class _{constructor(t){this._popup=document.querySelector(t),this._submitButton=this._popup.querySelector(".popup__button"),this._handleEscClose=this._handleEscClose.bind(this)}open(){this._popup.classList.add("popup_opened"),document.addEventListener("keydown",this._handleEscClose)}close(){this._popup.classList.remove("popup_opened"),document.removeEventListener("keydown",this._handleEscClose)}_handleEscClose(t){"Escape"===t.key&&this.close()}setEventListeners(){this._popup.addEventListener("mousedown",(t=>{t.target.classList.contains("popup_opened")&&this.close(),t.target.classList.contains("popup__close")&&this.close()}))}}class u extends _{constructor(t,e){super(t),this._form=this._popup.querySelector(".popup__form"),this._formSubmit=e,this._inputList=Array.from(this._form.querySelectorAll(".popup__input"))}getInputValues(){return this._formValues={},this._inputList.forEach((t=>{this._formValues[t.name]=t.value})),this._formValues}setInputValues(t){this._inputList.forEach((e=>{e.value=t[e.name]}))}close(){super.close(),this._form.reset()}setEventListeners(){super.setEventListeners(),this._form.addEventListener("submit",(t=>{t.preventDefault();const e=this._submitButton.textContent;this._submitButton.textContent="Сохранение...",this._formSubmit(this.getInputValues()).then((()=>this.close())).catch((function(t){console.log("Ошибка:"+t)})).finally((()=>{this._submitButton.textContent=e}))}))}}const c=new u(".popup_profile",(function(t){return m.patchProfileData({name:t.username,about:t.about}).then((function(t){d.setUserInfo(t.name,t.about,t.avatar)}))}));c.setEventListeners();const p=new u(".popup_card",(function(t){const e={name:t.card,link:t.link};return m.postNewCard(e).then((function(t){g.addItem(E(t,t.owner))}))}));p.setEventListeners();const d=new class{constructor(t){this._nameUser=document.querySelector(t.nameSelector),this._aboutUser=document.querySelector(t.aboutSelector),this._profileImage=document.querySelector(t.profileImage)}getUserInfo(){return this._userInfo={username:this._nameUser.textContent,about:this._aboutUser.textContent},this._userInfo}setUserInfo(t,e,n){this._nameUser.textContent=t,this._aboutUser.textContent=e,this._profileImage.src=n}}({nameSelector:".profile__title",aboutSelector:".profile__subtitle",profileImage:".profile__image"}),m=new class{constructor(t){this._baseUrl=t.baseUrl,this._headers=t.headers,this._authorization=t.headers.authorization}_checkResponse(t){return t.ok?t.json():Promise.reject(`Ошибка ${t.status}`)}getInitialCards(){return fetch(`${this._baseUrl}/cards`,{headers:{authorization:this._authorization}}).then(this._checkResponse)}postNewCard({name:t,link:e}){return fetch(`${this._baseUrl}/cards`,{method:"POST",headers:{authorization:this._authorization,"Content-Type":"application/json"},body:JSON.stringify({name:t,link:e})}).then(this._checkResponse)}deleteCard(t){return fetch(`${this._baseUrl}/cards/${t}`,{method:"DELETE",headers:{authorization:this._authorization,"Content-Type":"application/json"}}).then(this._checkResponse)}getProfileData(){return fetch(`${this._baseUrl}/users/me`,{headers:{authorization:this._authorization}}).then(this._checkResponse)}getAllNeededData(){return Promise.all([this.getInitialCards(),this.getProfileData()])}patchProfileData({name:t,about:e}){return fetch(`${this._baseUrl}/users/me`,{method:"PATCH",headers:{authorization:this._authorization,"Content-Type":"application/json"},body:JSON.stringify({name:t,about:e})}).then(this._checkResponse)}patchAvatar(t){return fetch(`${this._baseUrl}/users/me/avatar`,{method:"PATCH",headers:{authorization:this._authorization,"Content-Type":"application/json"},body:JSON.stringify({avatar:t})}).then(this._checkResponse)}putLike=t=>fetch(`${this._baseUrl}/cards/${t}/likes`,{method:"PUT",headers:{authorization:this._authorization,"Content-Type":"application/json"}}).then(this._checkResponse);deleteLike=t=>fetch(`${this._baseUrl}/cards/${t}/likes`,{method:"DELETE",headers:{authorization:this._authorization,"Content-Type":"application/json"}}).then(this._checkResponse)}({baseUrl:"https://mesto.nomoreparties.co/v1/cohort-66",headers:{authorization:"5ac978e5-969c-4910-b25a-b18a6af9a695","Content-Type":"application/json"}});e.addEventListener("click",(function(t){t.preventDefault(),y.resetInput(),c.setInputValues(d.getUserInfo()),c.open()})),s.addEventListener("click",(function(t){t.preventDefault(),L.resetInput(),p.open()})),o.addEventListener("click",(()=>{b.resetInput(),C.open()}));const f=new class extends _{constructor(t){super(t),this._photo=this._popup.querySelector(".popup__photo"),this._text=this._popup.querySelector(".popup__text")}open=t=>{this._photo.src=t.link,this._text.textContent=t.name,this._photo.alt=t.name,super.open()}}(".popup_picture");function v(t){f.open(t)}f.setEventListeners();const k=new class extends _{constructor(t,e){super(t),this._form=this._popup.querySelector(".popup__form"),this._formSubmit=e}open=t=>{super.open(),this._element=t};setEventListeners(){super.setEventListeners(),this._form.addEventListener("submit",(t=>{t.preventDefault(),this._formSubmit(this._element)}))}}(".popup_warning",(t=>{m.deleteCard(t._data._id).then((function(e){t.removeCard(),k.close()})).catch((function(t){console.log("Ошибка:"+t)}))}));k.setEventListeners();const b=new h(t,a);b.enableValidation();const C=new u(".popup_avatar",(function(t){return m.patchAvatar(t.avatar).then((function(t){d.setUserInfo(t.name,t.about,t.avatar)}))}));function E(t,e){const n=new l(t,r,v,k.open,e,(function(t,e){e.target.classList.contains("elements__like_button_active")?m.deleteLike(t).then((t=>{n.dislikeCard(t)})).catch((function(t){console.log("Ошибка:"+t)})):m.putLike(t).then((t=>{n.likeCard(t)})).catch((function(t){console.log("Ошибка:"+t)}))}));return n.generateCard()}C.setEventListeners();const g=new class{constructor(t,e){this._renderer=t,this._container=document.querySelector(e)}renderItems(t,e){t.forEach((t=>{this._renderer(t,e)}))}addItem(t){this._container.prepend(t)}}(((t,e)=>{const n=E(t,e);g.addItem(n)}),".elements");m.getAllNeededData().then((function(t){const[e,n]=t;g.renderItems(e.reverse(),n),d.setUserInfo(n.name,n.about,n.avatar)})).catch((function(t){console.log("Ошибка:"+t)}));const y=new h(t,n),L=new h(t,i);y.enableValidation(),L.enableValidation()})();